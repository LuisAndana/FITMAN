<!-- Overlay Modal -->
<div class="modal-overlay" *ngIf="isOpen" (click)="closeModal()"></div>

<!-- Modal Principal -->
<div class="modal" *ngIf="isOpen">
  <!-- Header -->
  <div class="modal-header">
    <h2 class="modal-title">Rese√±as y Calificaciones</h2>
    <button class="modal-close" type="button" (click)="closeModal()" aria-label="Cerrar">
      ‚úï
    </button>
  </div>

  <!-- Contenido -->
  <div class="modal-body">
    <!-- Estado de carga -->
    <div *ngIf="loading" class="state-loading">
      <div class="spinner"></div>
      <p>Cargando rese√±as...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !loading" class="state-error">
      <div class="error-icon">‚ö†Ô∏è</div>
      <p>{{ error }}</p>
    </div>

    <!-- Contenido disponible -->
    <div *ngIf="!loading && !error">
      <!-- SECCI√ìN 1: ESTAD√çSTICAS -->
      <section *ngIf="stats && stats.total_resenas > 0" class="stats-section">
        <div class="stats-header">
          <div class="rating-big">
            <div class="rating-number">{{ stats.calificacion_promedio }}</div>
            <div class="rating-stars">
              <span
                *ngFor="let star of [1, 2, 3, 4, 5]"
                class="star"
                [class.filled]="isStarFilled(star, stats.calificacion_promedio)"
              >
                ‚òÖ
              </span>
            </div>
            <div class="rating-count">{{ stats.total_resenas }} rese√±a<span *ngIf="stats.total_resenas !== 1">s</span></div>
          </div>

          <!-- Distribuci√≥n de estrellas -->
          <div class="distribution">
            <div class="dist-row" *ngFor="let stars of [5, 4, 3, 2, 1]">
              <span class="dist-label">{{ stars }} ‚òÖ</span>
              <div class="dist-bar">
                <div
                  class="dist-fill"
                  [style.width]="getProgressWidth(
                    stats.distribucion_estrellas[stars.toString()] || 0,
                    stats.total_resenas
                  )"
                ></div>
              </div>
              <span class="dist-count">
                {{ stats.distribucion_estrellas[stars.toString()] || 0 }}
              </span>
            </div>
          </div>
        </div>
      </section>

      <!-- Estado: Sin rese√±as -->
      <div *ngIf="(!stats || stats.total_resenas === 0) && !loading" class="state-empty">
        <div class="empty-icon">üìù</div>
        <h3>Sin rese√±as a√∫n</h3>
        <p>S√© el primero en calificar a este nutri√≥logo</p>
      </div>

      <!-- SECCI√ìN 2: LISTADO DE RESE√ëAS -->
      <section *ngIf="resenas.length > 0" class="resenas-section">
        <h3 class="resenas-title">Rese√±as de clientes</h3>

        <article *ngFor="let resena of resenas" class="resena-card">
          <!-- Encabezado -->
          <div class="resena-header">
            <div class="resena-author">
              <div class="author-avatar">
                {{ (resena.cliente_nombre || 'C').charAt(0) | uppercase }}
              </div>
              <div class="author-info">
                <p class="author-name">{{ resena.cliente_nombre || 'Cliente an√≥nimo' }}</p>
                <p class="author-date">{{ formatDate(resena.creado_en) }}</p>
              </div>
            </div>

            <!-- Insignia verificado -->
            <span *ngIf="resena.verificado" class="badge-verified">‚úì Verificado</span>
          </div>

          <!-- Calificaci√≥n y t√≠tulo -->
          <div class="resena-rating">
            <div class="stars-row">
              <span
                *ngFor="let star of getStars(resena.calificacion)"
                class="star"
                [class.filled]="isStarFilled(star, resena.calificacion)"
              >
                ‚òÖ
              </span>
            </div>
            <h4 class="resena-titulo" *ngIf="resena.titulo">{{ resena.titulo }}</h4>
          </div>

          <!-- Comentario -->
          <p class="resena-comentario" *ngIf="resena.comentario">
            {{ resena.comentario }}
          </p>
        </article>
      </section>
    </div>
  </div>

  <!-- Footer -->
  <div class="modal-footer">
    <button class="btn-close" type="button" (click)="closeModal()">Cerrar</button>
  </div>
</div>