<div class="pago-container">

  <!-- ========== HEADER ========== -->
  <div class="pago-header">
    <h1 class="pago-title">Completar Pago</h1>
    <p class="pago-subtitle">Contrataci√≥n segura de servicios de nutrici√≥n</p>
  </div>

  <!-- ========== ESTADO: CARGANDO ========== -->
  <div *ngIf="cargando" class="estado-cargando fade-in">
    <div class="spinner"></div>
    <p>Cargando informaci√≥n del contrato...</p>
  </div>

  <!-- ========== ESTADO: ERROR ========== -->
  <div *ngIf="error && !cargando" class="estado-error fade-in">
    <div class="alert alert-error">
      <span class="alert-icon">‚ö†Ô∏è</span>
      <div class="alert-content">
        <h3>Hubo un problema</h3>
        <p>{{ error }}</p>
      </div>
    </div>

    <div class="error-actions">
      <button class="btn outline" (click)="reintentar()" type="button">
        üîÑ Reintentar
      </button>
      <button class="btn ghost" (click)="irAlDashboard()" type="button">
        ‚Üê Volver
      </button>
    </div>
  </div>

  <!-- ========== ESTADO: EXITOSO ========== -->
  <div *ngIf="pagoExitoso && !cargando" class="estado-exitoso fade-in">
    <div class="success-container">
      <!-- Checkmark animado -->
      <div class="success-checkmark">
        <div class="check-icon">‚úì</div>
      </div>

      <h2 class="success-title">¬°Pago completado exitosamente!</h2>
      <p class="success-subtitle">Tu contrato con el nutri√≥logo ha sido activado.</p>

      <!-- Detalles del pago -->
      <div class="success-details" *ngIf="contrato">
        <h3>Resumen de tu contrato:</h3>

        <div class="detail-row">
          <span class="detail-label">Nutri√≥logo:</span>
          <span class="detail-value">{{ contrato.nutriologo_nombre || 'N/A' }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label">Monto pagado:</span>
          <span class="detail-value">${{ contrato.monto }}</span>
        </div>

        <div class="detail-row">
          <span class="detail-label">Duraci√≥n:</span>
          <span class="detail-value">{{ contrato.duracion_meses }} mes{{ contrato.duracion_meses !== 1 ? 'es' : '' }}</span>
        </div>

        <div class="detail-row total">
          <span class="detail-label">Total:</span>
          <span class="detail-value">${{ contrato.monto * contrato.duracion_meses }}</span>
        </div>
      </div>

      <!-- Pr√≥ximos pasos -->
      <div class="next-steps">
        <h3>Pr√≥ximos pasos:</h3>
        <ol>
          <li>El nutri√≥logo te contactar√° en <strong>24 horas</strong></li>
          <li>Tendr√°s tu primera consulta en <strong>3-5 d√≠as h√°biles</strong></li>
          <li>Accede a tu panel para ver el estado del contrato</li>
        </ol>
      </div>

      <!-- Botones de acci√≥n -->
      <div class="success-actions">
        <button class="btn primary large" (click)="irAlDashboard()" type="button">
          Ir al Dashboard
        </button>
        <p class="security-note">
          üîí Tu informaci√≥n de pago es 100% segura y encriptada
        </p>
      </div>
    </div>
  </div>

  <!-- ========== ESTADO: FORMULARIO / PROCESANDO ========== -->
  <div *ngIf="contrato && !cargando && !error && !pagoExitoso" class="pago-content fade-in">

    <div class="pago-grid">

      <!-- COLUMNA 1: RESUMEN DEL CONTRATO -->
      <section class="resumen-section">
        <h2>Resumen del Contrato</h2>

        <!-- Informaci√≥n del nutri√≥logo -->
        <div class="resumen-header">
          <div class="nutriologo-info">
            <div class="nutriologo-avatar">
              {{ (contrato.nutriologo_nombre || 'N')[0] | uppercase }}
            </div>
            <div>
              <p class="nutriologo-name">{{ contrato.nutriologo_nombre }}</p>
              <p class="nutriologo-type">Nutri√≥logo certificado</p>
            </div>
          </div>
        </div>

        <!-- Items de resumen -->
        <div class="resumen-items">
          <div class="resumen-item">
            <span class="item-label">Duraci√≥n:</span>
            <span class="item-value">{{ contrato.duracion_meses }} mes{{ contrato.duracion_meses !== 1 ? 'es' : '' }}</span>
          </div>

          <div class="resumen-item">
            <span class="item-label">Monto por mes:</span>
            <span class="item-value">${{ contrato.monto }}</span>
          </div>

          <div class="resumen-item total">
            <span class="item-label">Total a pagar:</span>
            <span class="item-value">${{ contrato.monto * contrato.duracion_meses }}</span>
          </div>
        </div>

        <!-- T√©rminos y condiciones -->
        <div class="terms-section">
          <div class="checkbox-group">
            <input 
              type="checkbox" 
              id="terms-check"
              (change)="aceptaTerminos = $event.target.checked"
              [checked]="aceptaTerminos"
              class="checkbox-input"
            />
            <label for="terms-check" class="checkbox-label">
              Acepto los <a href="#" target="_blank" class="link">t√©rminos y condiciones</a>
            </label>
          </div>
        </div>
      </section>

      <!-- COLUMNA 2: FORMULARIO DE PAGO -->
      <section class="formulario-section">
        <h2>Informaci√≥n de Pago</h2>

        <form [formGroup]="form" (ngSubmit)="procesarPago()" class="pago-form">

          <!-- Campo: Nombre completo -->
          <div class="form-group">
            <label for="nombre" class="form-label">Nombre completo</label>
            <input
              id="nombre"
              formControlName="nombre"
              type="text"
              placeholder="Tu nombre completo"
              class="form-input"
              [class.error]="form.get('nombre')?.invalid && form.get('nombre')?.touched"
              autocomplete="name"
            />
            <span class="error-message" *ngIf="form.get('nombre')?.hasError('required') && form.get('nombre')?.touched">
              El nombre es requerido
            </span>
            <span class="error-message" *ngIf="form.get('nombre')?.hasError('minlength') && form.get('nombre')?.touched">
              El nombre debe tener al menos 3 caracteres
            </span>
          </div>

          <!-- Campo: Email -->
          <div class="form-group">
            <label for="email" class="form-label">Correo electr√≥nico</label>
            <input
              id="email"
              formControlName="email"
              type="email"
              placeholder="tu@email.com"
              class="form-input"
              [class.error]="form.get('email')?.invalid && form.get('email')?.touched"
              autocomplete="email"
            />
            <span class="error-message" *ngIf="form.get('email')?.hasError('required') && form.get('email')?.touched">
              El email es requerido
            </span>
            <span class="error-message" *ngIf="form.get('email')?.hasError('email') && form.get('email')?.touched">
              Ingresa un email v√°lido
            </span>
          </div>

          <!-- Campo: Tarjeta (Stripe Card Element) -->
          <div class="form-group">
            <label for="card-element" class="form-label">Informaci√≥n de la tarjeta</label>
            <!-- CONTENEDOR IMPORTANTE PARA STRIPE -->
            <div 
              id="card-element" 
              class="stripe-card-element"
              style="min-height: 40px;"
            >
              <!-- Stripe montar√° el elemento aqu√≠ autom√°ticamente -->
            </div>
            <span class="error-message" *ngIf="errorTarjeta">
              {{ errorTarjeta }}
            </span>
          </div>

          <!-- Aviso de seguridad -->
          <div class="security-banner">
            <span class="security-icon">üîí</span>
            <span class="security-text">Tu informaci√≥n de pago es 100% segura y encriptada con Stripe</span>
          </div>

          <!-- Bot√≥n de pago -->
          <button
            type="submit"
            class="btn primary large"
            [disabled]="procesandoPago || !aceptaTerminos || form.invalid"
            [class.loading]="procesandoPago"
          >
            <span *ngIf="!procesandoPago">
              üí≥ Pagar ${{ contrato.monto * contrato.duracion_meses }}
            </span>
            <span *ngIf="procesandoPago" class="loading-text">
              <span class="spinner-mini"></span>
              Procesando pago...
            </span>
          </button>

          <!-- Alternativa: Volver -->
          <button
            type="button"
            class="btn ghost full-width"
            (click)="irAlDashboard()"
            [disabled]="procesandoPago"
          >
            ‚Üê Volver sin pagar
          </button>

        </form>
      </section>

    </div>

    <!-- Informaci√≥n adicional -->
    <section class="info-section">
      <h3>¬øDudas sobre el pago?</h3>
      <p>Puedes cancelar dentro de los primeros 7 d√≠as y recibir un reembolso completo.</p>
      <a href="mailto:soporte@fitman.com" class="link-support">
        üí¨ Contactar con soporte
      </a>
    </section>

  </div>

</div>