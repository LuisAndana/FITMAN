<div class="pacientes-container">
  <!-- Header Principal -->
  <div class="header-section">
    <div class="header-content">
      <h1 class="header-title">ğŸ‘¥ Mis Pacientes</h1>
      <p class="header-subtitle">Gestiona tus clientes y crea dietas personalizadas</p>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando pacientes...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !cargando" class="error-banner">
    <div class="error-content">
      <span class="error-icon">âš ï¸</span>
      <div class="error-message">
        <strong>Error:</strong> {{ error }}
      </div>
      <button (click)="cargarClientes()" class="retry-btn">ğŸ”„ Reintentar</button>
    </div>
  </div>

  <!-- Grid de Pacientes -->
  <div *ngIf="!cargando && clientes.length > 0" class="pacientes-grid">
    <div 
      *ngFor="let cliente of clientes" 
      class="paciente-card"
      (click)="abrirPerfilCliente(cliente)"
      [class.selected]="clienteSeleccionado?.id_usuario === cliente.id_usuario"
    >
      <div class="card-header">
        <div class="avatar">{{ cliente.nombre.charAt(0).toUpperCase() }}</div>
        <div class="header-info">
          <h3 class="paciente-nombre">{{ cliente.nombre }}</h3>
          <p class="paciente-objetivo">{{ formatearObjetivo(cliente.objetivo) }}</p>
        </div>
      </div>

      <div class="card-stats">
        <div class="stat-item">
          <span class="stat-icon">ğŸ‘¤</span>
          <span class="stat-label">Edad</span>
          <span class="stat-value">{{ cliente.edad || 'N/A' }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-icon">âš–ï¸</span>
          <span class="stat-label">Peso</span>
          <span class="stat-value">{{ cliente.peso || 'N/A' }} kg</span>
        </div>
        <div class="stat-item">
          <span class="stat-icon">ğŸ“</span>
          <span class="stat-label">Altura</span>
          <span class="stat-value">{{ cliente.altura || 'N/A' }} m</span>
        </div>
      </div>

      <div class="card-footer">
        <span class="status-badge" [class]="'status-' + cliente.contrato_estado?.toLowerCase()">
          {{ cliente.contrato_estado }}
        </span>
      </div>
    </div>
  </div>

  <!-- Sin Pacientes -->
  <div *ngIf="!cargando && clientes.length === 0 && !error" class="empty-state">
    <div class="empty-icon">ğŸ‘¥</div>
    <h2>Sin pacientes registrados</h2>
    <p>Los pacientes que contraten tus servicios aparecerÃ¡n aquÃ­</p>
  </div>

  <!-- MODAL: Detalle del Paciente -->
  <div *ngIf="mostrarDetalle && clienteSeleccionado" class="modal-overlay" (click)="cerrarDetalle()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      
      <!-- Modal Header -->
      <div class="modal-header">
        <div class="modal-header-content">
          <h2>{{ clienteSeleccionado.nombre }}</h2>
          <p class="modal-subtitle">{{ formatearObjetivo(clienteSeleccionado.objetivo) }}</p>
        </div>
        <button class="close-btn" (click)="cerrarDetalle()">âœ•</button>
      </div>

      <!-- Modal Scroll -->
      <div class="modal-scroll">
        
        <!-- INFORMACIÃ“N PERSONAL -->
        <div *ngIf="!mostrarFormularioDieta && !dietaGenerada" class="section-container">
          <div class="section-header">
            <h3>ğŸ“‹ InformaciÃ³n Personal</h3>
          </div>
          
          <div class="info-grid">
            <div class="info-card">
              <span class="info-label">Edad</span>
              <span class="info-value">{{ clienteSeleccionado.edad || 'N/A' }} aÃ±os</span>
            </div>
            <div class="info-card">
              <span class="info-label">Peso Actual</span>
              <span class="info-value">{{ clienteSeleccionado.peso || 'N/A' }} kg</span>
            </div>
            <div class="info-card">
              <span class="info-label">Altura</span>
              <span class="info-value">{{ clienteSeleccionado.altura || 'N/A' }} m</span>
            </div>
            <div class="info-card">
              <span class="info-label">Peso Inicial</span>
              <span class="info-value">{{ clienteSeleccionado.peso_inicial || 'N/A' }} kg</span>
            </div>
            <div class="info-card">
              <span class="info-label">Objetivo</span>
              <span class="info-value">{{ formatearObjetivo(clienteSeleccionado.objetivo) }}</span>
            </div>
            <div class="info-card">
              <span class="info-label">IMC</span>
              <span class="info-value">
                {{ calcularIMC(clienteSeleccionado) || 'N/A' }}
                <span *ngIf="calcularIMC(clienteSeleccionado)" class="imc-class">
                  ({{ clasificacionIMC(calcularIMC(clienteSeleccionado)!) }})
                </span>
              </span>
            </div>
          </div>
        </div>

        <!-- INFORMACIÃ“N MÃ‰DICA -->
        <div *ngIf="!mostrarFormularioDieta && !dietaGenerada" class="section-container">
          <div class="section-header">
            <h3>âš•ï¸ InformaciÃ³n MÃ©dica</h3>
          </div>
          
          <div class="medical-content">
            <div *ngIf="clienteSeleccionado.enfermedades && clienteSeleccionado.enfermedades.length > 0">
              <h4>Condiciones MÃ©dicas</h4>
              <ul class="conditions-list">
                <li *ngFor="let enfermedad of clienteSeleccionado.enfermedades">
                  {{ enfermedad }}
                </li>
              </ul>
            </div>
            
            <div *ngIf="clienteSeleccionado.descripcion_medica">
              <h4>DescripciÃ³n MÃ©dica</h4>
              <p>{{ clienteSeleccionado.descripcion_medica }}</p>
            </div>

            <div *ngIf="!clienteSeleccionado.enfermedades?.length && !clienteSeleccionado.descripcion_medica">
              <p class="no-medical">Sin condiciones mÃ©dicas registradas</p>
            </div>
          </div>
        </div>

        <!-- FORMULARIO GENERAR DIETA -->
        <div *ngIf="mostrarFormularioDieta" class="form-container">
          <div class="section-header">
            <h3>ğŸ¤– Generar Dieta con IA</h3>
          </div>
          <p class="form-subtitle">Completa los detalles para crear una dieta personalizada</p>

          <form (ngSubmit)="generarDieta()">
            <div class="form-group">
              <label for="nombre">Nombre de la Dieta *</label>
              <input
                id="nombre"
                type="text"
                [(ngModel)]="nombreDieta"
                name="nombreDieta"
                placeholder="Ej: Dieta de PÃ©rdida de Grasa"
                required
              />
            </div>

            <div class="form-group">
              <label for="calorias">CalorÃ­as Objetivo *</label>
              <input
                id="calorias"
                type="number"
                [(ngModel)]="caloriasObjetivo"
                name="caloriasObjetivo"
                min="1000"
                max="5000"
              />
              <p class="form-hint">CalorÃ­as diarias recomendadas</p>
            </div>

            <div class="form-group">
              <label for="dias">DÃ­as de DuraciÃ³n</label>
              <select [(ngModel)]="diasDuracion" name="diasDuracion" id="dias">
                <option value="7">7 dÃ­as (1 semana)</option>
                <option value="14">14 dÃ­as (2 semanas)</option>
                <option value="21">21 dÃ­as (3 semanas)</option>
                <option value="30">30 dÃ­as (1 mes)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="preferencias">Preferencias Especiales</label>
              <textarea
                id="preferencias"
                [(ngModel)]="preferencias"
                name="preferencias"
                placeholder="Ej: Sin gluten, vegetariano, alergias, etc."
                rows="3"
              ></textarea>
            </div>

            <div *ngIf="error" class="form-error">{{ error }}</div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary" [disabled]="generandoDieta">
                <span *ngIf="!generandoDieta">âœ¨ Generar Dieta</span>
                <span *ngIf="generandoDieta">â³ Generando...</span>
              </button>
              <button type="button" class="btn btn-secondary" (click)="cancelarFormulario()" [disabled]="generandoDieta">
                Cancelar
              </button>
            </div>
          </form>
        </div>

        <!-- DIETA GENERADA - PREVIEW RÃPIDO -->
        <div *ngIf="dietaGenerada && !mostrarFormularioDieta" class="dieta-container">
          <div class="dieta-header">
            <h3>âœ… Dieta Generada</h3>
            <p class="dieta-titulo">{{ dietaGenerada.nombre }}</p>
          </div>

          <!-- Info RÃ¡pida -->
          <div class="dieta-info-quick">
            <div class="quick-item">
              <span class="quick-label">ğŸ”¥ CalorÃ­as</span>
              <span class="quick-value">{{ dietaGenerada.calorias_totales }} kcal/dÃ­a</span>
            </div>
            <div class="quick-item">
              <span class="quick-label">ğŸ¯ Objetivo</span>
              <span class="quick-value">{{ formatearObjetivo(dietaGenerada.objetivo) }}</span>
            </div>
            <div class="quick-item">
              <span class="quick-label">ğŸ“… DuraciÃ³n</span>
              <span class="quick-value">{{ diasDuracion }} dÃ­as</span>
            </div>
          </div>

          <!-- Preview del contenido (primeras lÃ­neas) -->
          <div class="dieta-preview">
            <pre class="dieta-texto-preview">{{ dietaGenerada.contenido | slice:0:500 }}...</pre>
          </div>
        </div>

      </div>

      <!-- Modal Footer - Botones SIEMPRE visibles -->
      <div class="modal-footer">
        <!-- Si hay dieta generada, mostrar botones de dieta -->
        <div *ngIf="dietaGenerada && !mostrarFormularioDieta" class="footer-buttons">
          <button class="btn btn-primary" (click)="abrirDetalleDieta(dietaGenerada)">
            ğŸ‘ï¸ Ver Dieta Completa
          </button>
          <button class="btn btn-secondary" (click)="abrirFormularioDieta()">
            ğŸ”„ Nueva Dieta
          </button>
        </div>

        <!-- Si no hay dieta o estÃ¡ en formulario, mostrar botones normales -->
        <div *ngIf="!dietaGenerada || mostrarFormularioDieta" class="footer-buttons">
          <button class="btn btn-primary" (click)="abrirFormularioDieta()" *ngIf="!mostrarFormularioDieta">
            ğŸ¥— Generar Dieta con IA
          </button>
          <button class="btn btn-secondary" (click)="cerrarDetalle()">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… FUERA DEL CONTENEDOR: Modal Profesional de Dieta con 3 PestaÃ±as -->
<!-- Debe estar AQUÃ (fuera) para que NO se cierre cuando cierres el modal de pacientes -->
<app-dieta-detalle 
  *ngIf="mostrarDetalleDieta && dietaSeleccionada"
  [dieta]="dietaSeleccionada"
  (cerrar)="cerrarDetalleDieta()"
  (descargarPDF)="descargarDietaPDF($event)"
></app-dieta-detalle>